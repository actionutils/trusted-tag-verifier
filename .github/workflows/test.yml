name: Test Trusted Tag Verifier

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
  pull_request:
    paths-ignore:
      - '**.md'

permissions:
  contents: read

jobs:
  test-verify-tag:
    name: Test Tag Verification
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify Tag (Shorthand)
        id: verify-shorthand
        uses: ./
        with:
          verify: 'actionutils/trusted-tag-releaser@v0.0.30'

      - name: Display Verification Results (Shorthand)
        run: |
          echo "Verified: ${{ steps.verify-shorthand.outputs.verified }}"
          echo "Repository: ${{ steps.verify-shorthand.outputs.repository }}"
          echo "Tag: ${{ steps.verify-shorthand.outputs.tag-name }}"
          echo "Commit: ${{ steps.verify-shorthand.outputs.commit-sha }}"
          echo "Tagger: ${{ steps.verify-shorthand.outputs.tagger-name }} <${{ steps.verify-shorthand.outputs.tagger-email }}>"
          echo "Message: ${{ steps.verify-shorthand.outputs.tag-message }}"

          # Display the full JSON
          echo "Verification Result (JSON):"
          echo '${{ steps.verify-shorthand.outputs.verification-result }}' | jq

      - name: Test Invalid Tag (Should Fail)
        id: verify-invalid-tag
        uses: ./
        with:
          verify: 'actionutils/trusted-tag-releaser@non-existent-tag'
          fail-on-verification-error: 'false'
        continue-on-error: true

      - name: Check Invalid Tag Result
        run: |
          if [[ "${{ steps.verify-invalid-tag.outcome }}" == "failure" ]]; then
            echo "✅ Test passed: Invalid tag verification failed as expected"
          else
            echo "❌ Test failed: Invalid tag verification did not fail"
            exit 1
          fi

      - name: Test Invalid Certificate Issuer (Should Not Fail)
        id: verify-invalid-issuer
        uses: ./
        with:
          verify: 'actionutils/trusted-tag-releaser@v0.0.30'
          certificate-oidc-issuer: 'https://invalid-issuer.example.com'
          fail-on-verification-error: 'false'

      - name: Check Invalid Certificate Issuer Result
        run: |
          if [[ "${{ steps.verify-invalid-issuer.outputs.verified }}" == "false" ]]; then
            echo "✅ Test passed: Invalid certificate issuer verification returned false as expected"
            echo "Verification Result (JSON):"
            echo '${{ steps.verify-invalid-issuer.outputs.verification-result }}' | jq
          else
            echo "❌ Test failed: Invalid certificate issuer verification did not return false"
            exit 1
          fi

      - name: Test Invalid Certificate Issuer (Should Fail)
        id: verify-invalid-issuer-fail
        uses: ./
        with:
          verify: 'actionutils/trusted-tag-releaser@v0.0.30'
          certificate-oidc-issuer: 'https://invalid-issuer.example.com'
          fail-on-verification-error: 'true'
        continue-on-error: true

      - name: Check Invalid Certificate Issuer Fail Result
        run: |
          if [[ "${{ steps.verify-invalid-issuer-fail.outcome }}" == "failure" ]]; then
            echo "✅ Test passed: Invalid certificate issuer verification failed as expected"
          else
            echo "❌ Test failed: Invalid certificate issuer verification did not fail"
            exit 1
          fi

  test-downloaded-action:
    name: Test Downloaded Action Path Detection
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Harden the runner (Audit all outbound calls)
        uses: step-security/harden-runner@f4a75cfd619ee5ce8d5b864b0d183aff3c69b55a # v2.13.1
        with:
          egress-policy: audit

      - uses: actions/checkout@v5

      # Test with no @ref - it should detect the downloaded action
      - name: Test with no @ref (should use downloaded action)
        uses: ./
        with:
          verify: 'actionutils/trusted-tag-verifier'

      # Now use the actual trusted-tag-verifier that was pre-downloaded by the runner
      - name: Use trusted-tag-verifier as a target
        uses: actionutils/trusted-tag-verifier@v0
        with:
          verify: 'actionutils/trusted-tag-releaser@v0'
